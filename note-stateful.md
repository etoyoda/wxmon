# 状態遷移的にとらえるべき電文とそうでない電文

総じて気象データはものすごく更新頻度が高くて、日々更新されていくところに地図とは違った特色があるわけですが、その更新の様態は一通りではありません。データの保存・整理のやりかたを考える上で、認識しておかねばならないことです。

時系列の様態とかぼやけた言葉じゃなくて何か言葉があった（または昔コインした）ような気がするのですが、ちょっと思い出せません。

# 三類型
## 定時型データ（数値予報など）

一番扱いやすいのは、情報が発出される回数が決まっているものです。数値予報が典型例ですが、防災XMLでいうとたとえばアジア太平洋地上実況天気図が１日４回出るとかですね。実際の発表時刻には数分から数十分の日日変動がありますが、運用監視としては一定のデッドラインを決めて、発出されていないことをもって障害とみなすということになります。

こういう情報を保存するには、理念的には運用開始から無限の未来に伸びる時系列に沿った固定長配列に値を埋めていくイメージでストレージを持つことになります。取得APIとしては参照時刻や対象時刻を引数とするだけで一意にリソースが決められることになります。

##  随時型データ（気象情報・記録的短時間大雨情報・震度速報など）

定時データの対極は、情報が発出される回数が決まっていないものです。震度速報なんかがイメージしやすいかもしれませんが、地震があった１分後に別の地震があるかも知れませんし、一日の地震回数の上限も大自然は約束してくれません。まあ、毎秒数通あたりにスループットの設計上限を持つことは許されるでしょうが、１日・１年あたりのストレージ割当はそれと別に何桁か下の現実的ラインに持つしかないでしょう。

こういう情報は、連続体の時間に無限に密な点が打てるイメージでゆくのでしょう。現実のデジタル日時表現には解像度があり、たとえば秒単位ならば１秒に複数ありうるかどうかも検討しておくべきです。APIとしては、時間範囲（あるいは月や日付）を指定した検索で資源IDのリストを得て、あらためてIDを指定して取得するといった作りになります。用途を限定すればID概念を排したAPIが作れる場合もあるでしょうが、まあそれは応用です。

まあ、でも、一つの電文を取得したら、それだけで解釈ができるので、システムづくりはやりやすいともいえそうです。

## 状態遷移型データ（注意報・警報・天気予報など）

ちょっと現実的な応用を考えると随時だけで済まされないことが多いのが、注意報・警報など、地理空間上のポリゴンの状態を遷移させるような情報です。

たとえばウェブ地図にポリゴン色塗りをしようとすると、府県単位でバラバラのタイミングで発表されるので、現状有効な電文を集めてくる必要があります。千葉県で発表されたタイミングで茨城県の直近の電文は当日中にある保証はありません。数日前かも知れませんし、何ヶ月も前かもしれません。特務機関NERVの発表する地図は、電文が対象とする領域の外を黒塗りで明示していてうまい方法ですが、いつでもこの手が使えるわけではないでしょう。

あるいは一地点を指定して、エッジトリガ情報を出すような応用があります。たとえば警報の発表・解除時にメールするとかですね。これも情報を受けた時点で、直近過去状態を知る必要があります。「気象特別警報・警報・注意報」電文についてはエッジトリガがやりやすいように Item/Kind/Status="発表”/"解除” や Item/ChangeStatus!='変化無’ といったマークアップがなされているようですが、そこをどう使ったら確実なサービスができるか要確認と思っているのと、週間天気予報で特定府県の特定日について「雨」または「雪」の文字がついたら報知するといった応用を考えると、受信側でやるしかない場合は存在します。

まあなんだかんだで全状態をコンソリデートしてDB化しておかないと現実的な応用には答えられないだろうという感じがします。バカ正直に状態×時間の形式で持つのがよいかは別問題として。

# 具体

## 状態管理しがいのありそうなデータリスト

### 地方海上警報

- ヘッダ： VPCU51
- 判別：/Report/Control/Title equals ”地方海上警報（Ｈ２８）” and /Report/Control/Status equals "通常”
- 予報区：地方海上予報区
- 有効期限管理： /Report/Head/ValidDateTime でエクスパイアするか、それまでに同種情報で上書き
- 収集対象： foreach /Report/Head/Headline/Information[@type="地方海上警報"]/Item
- ジオリファレンス： Areas/Area/Code で特定される。
  リストは https://tako.toyoda-eizi.net/2018/jmxdocs/jmaxml_20181122_Code/20130523_AreaMarineAJ.xls の AreaMarineJ シート。
  "AreaMarineJ.#{Areas/Area/Code}" とでもして保存するのがよいか。
- どのような状態がありうるか：
  Kind/Code なので、 "VPCU51.#{Kind/Code}" として保存するのがよいかと思いたくなるが、それはだめ。
  同一予報区に複数種類の地方海上警報が出うる（このとき複数 Item となる）ので、これらをまとめた状態をかんがえると品質管理の負担が大きい。
  要するにハザードごとにばらばらの状態にするしかないのだろう。
  霧と着氷と風は相互に独立だが、風は強さによって上書きされうる。
  また、 Kind/Code = "00" (Kind/Name = "海上警報解除") があると当該地区の全警報が解除になる。そういうふうに状態遷移をかかねばならない。

### 気象特別警報・警報・注意報

- ヘッダ：VPWW53
- 判別：/Report/Control/Title equals ”気象特別警報・警報・注意報” and /Report/Control/Status equals "通常”
- 予報区：市町村等
- 有効期限管理：解除されるまで有効
- タプル生成：  foreach /Report/Head/Headline/Information[@type="気象警報・注意報（市町村等）"]/Item { foreach Kind { set kind = Code; foreach ../Areas/Area { set area = Code; yield [kind, area]; }}} 

### 指定河川洪水予報

- ヘッダ：VXKO50-89
- 判別：/Report/Control/Title equals ”指定河川洪水予報” and /Report/Control/Status equals "通常”
- 予報区：三種類ある。
-- Information/@type="指定河川洪水予報（予報区域）" ：「利根川上流」のように河川を分割することがある。一覧は jmaxml_20??????_Code/201?????_AreaFloodForecast.xls で与えられる。
-- Information/@type="指定河川洪水予報（河川）"  ：予報区域より粗い単位らしく、「利根川」でひとまとめになっている。一覧は jmaxml_20??????_Code/201?????_AreaFloodForecast.xls で与えられる。
-- Information/@type="指定河川洪水予報（府県予報区等）"  ： 府県予報区なので相当粗いが、配信管理の観点で理解したらよいのだろう。 

### 土砂災害警戒情報

- ヘッダ：VXWW50
- 全体構造とエリアコードは気象警報と共通。カインドコードは 0、1、3しかない

### 府県週間天気予報

- 時間構造：対象時刻を日単位（00JST日界）で区切って提供される。エッジトリガをかけるならば、日（対象時刻）を指定して比較する。
- ヘッダ：VPFW50
- 判別：/Report/Control/Title equals ”府県週間天気予報” and /Report/Control/Status equals "通常”
- 予報区：区域予報（天気）と地点予報（気温）に分かれる。
- 解読
-- hash time = foreach /Report/Body/MeteorologicalInfos[@type="区域予報"]/TimeSeriesInfo/TimeDefines/TimeDefine { tupple @timeId, concat(DateTime, "/", Duration); }; 後略
- データ
-- 

### 津波警報・注意報・予報a
### 噴火警報・予報
### 府県海氷予報
### 警報級の可能性（明日まで）
### 警報級の可能性（明後日以降）
### ｛２週間気温予報については勉強する｝

## 明示的な解除報がないもの

- 竜巻注意情報（目撃情報付き） ｛雷注意報を補足するものとの整理｝
- スモッグ気象情報 ｛当日か翌日かが判別できれば｝
- 府県高温注意情報 ｛解除は時刻指定｝


